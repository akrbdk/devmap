#### Список ссылок

- [Развертывание образа в Docker Hub](https://kramarenko.com.ua/post/deploying_image_to_docker_hub)
- [Harbor — реестр для Docker-контейнеров с безопасностью «из коробки»](https://habr.com/ru/company/flant/blog/419727/)
- [Изучаем Docker, часть 1: основы](https://habr.com/ru/company/ruvds/blog/438796/)
- [Изучаем Docker, часть 2: термины и концепции](https://habr.com/ru/company/ruvds/blog/439978/)
- [Изучаем Docker, часть 3: файлы Dockerfile](https://habr.com/ru/company/ruvds/blog/439980/)
- [Изучаем Docker, часть 4: уменьшение размеров образов и ускорение их сборки](https://habr.com/ru/company/ruvds/blog/440658/)
- [Изучаем Docker, часть 5: команды](https://habr.com/ru/company/ruvds/blog/440660/)
- [Изучаем Docker, часть 6: работа с данными](https://habr.com/ru/company/ruvds/blog/441574/)
- [Dockerfile Instructions](https://kapeli.com/cheat_sheets/Dockerfile.docset/Contents/Resources/Documents/index)


- [Основы Kubernetes](https://habr.com/ru/post/258443/)
- [Контейнер LXC для веб-разработки как альтернатива Docker](https://habr.com/ru/post/563040/)


### Docker [&uarr;](#Readme)

Docker — это технология, которая позволяет создавать и использовать приложения в «родном» окружении. В основе Docker
лежит идея: если приложение работает у вас, то оно должно работать где угодно. Способ этого добиться очень простой —
нужно упаковать настройки окружения вместе с приложением.

Docker чаще всего применяется для развёртывания серверных приложений, но может использоваться и в мире фронтенда.

Docker Compose — это инструмент для запуска мультиконтейнерного приложения, которое не зависит от платформы и содержит
все необходимые для работы технологии и библиотеки. Конфигурация такого приложения записывается в одном текстовом файле
в формате YAML. Запускается приложение одной командой в терминале.

В файле compose.yaml могут быть следующие элементы верхнего уровня:

— version (скоро исключат): информация о версии формата файла конфигурации; — services (обязательный): список всех
контейнеров, которые нужно будет запустить; — networks: список подсетей Docker Network, которые объединяют группы
контейнеров в виртуальную локальную сеть (она может быть доступна из внешнего мира); — volumes: список томов, которые
будут доступны контейнерам, описанным в файле конфигурации; — configs: список параметров, которые позволяют запускать
контейнеры в различных режимах, не собирая их заново; — secrets: список чувствительных с точки зрения безопасности
параметров (то же, что и configs, но специального назначения).

Обычно жизненный цикл контейнера состоит из следующей последовательности состояний:

    Создание контейнера
    Работа контейнера
    Приостановка контейнера
    Возобновление работы контейнера
    Запуск контейнера
    Остановка контейнера
    Перезапуск контейнера
    Принудительная остановка контейнера
    Удаление контейнера

### Важные службы

Движок Docker Engine — приложение для управления объектами Docker. Оно включает в себя три компонента:

    -  интерфейс (Docker API);
    -  консольный клиент (Docker CLI) - в терминал вводят команды, начинающиеся с ключевого слова docker, обращаясь к клиенту. Затем клиент использует API Docker для отправки команд демону Docker.
    -  сервер (Docker Daemon) — это сервер Docker, который ожидает запросов к API Docker. Демон Docker управляет образами, контейнерами, сетями и томами.

Ваш компьютер называется Docker Host. Все операции, которые мы выполняем в интерфейсе или через консоль, выполняются
сервером через API движка.

Docker Desktop — пакет приложений с графическим интерфейсом, включающий специальную виртуальную машину для работы с
движком, визуальный интерфейс (Dashboard), консольный клиент, инструменты для работы с реестром Docker Hub и пр.

### Объекты Docker

    Образ (Docker Image) — прототип будущего контейнера, содержащий операционную систему, приложение или проект для сборки приложения. Образы состоят из слоёв. Каждый новый слой — это надстройка над предыдущим. Слои должны надстраиваться поверх базового образа, формируя новый. Например, базовым образом может быть образ операционной системы.

    Контейнер (Docker Container) — уже собранное и запущенное приложение в изолированном окружении, которое формируется послойно, в соответствии с образом. Каждый новый слой расширяет функциональность предыдущего, формируя стек используемых инструментов, платформ и настроек системных служб. Файловая система контейнера тоже стековая (Union File Systems). Каталоги и файлы отдельного слоя образа накладываются друг на друга, образуя единое целое.

    Том (Docker Volume) — папка, которую можно подключить (говорят «примонтировать») к контейнерам. Папка может быть связана с конкретной папкой на вашем компьютере, а может быть как бы сетевой для контейнеров на вашем компьютере. Тома необходимы для хранения файлов конфигурации, критических с точки зрения безопасности, файлов баз данных, файлов, которые нельзя удалять после окончания работы приложения.

    Сеть (Docker Network) — виртуальная локальная сеть, которая позволяет совместно использовать несколько запущенных контейнеров и соединять запущенный контейнер с вашим компьютером. В основном вы будете использовать три режима работы сетевой инфраструктуры Docker:

    bridge — когда контейнеры могут взаимодействовать между собой как веб-сервер и база данных.
    host — для доступа к локальному сетевому окружению на вашем компьютере.
    none — сеть для контейнеров полностью отключена.

### Инструменты

Docker Hub (реестр) — официальный реестр образов.

Опубликованные образы хранятся в Docker Hub. Существуют и другие публичные реестры образов:

    Google Cloud Container Registry;
    Azure Container Registry;
    IBM Cloud Container Registry;
    Oracle Cloud Infrastructure Container Registry;
    Yandex Container Registry.

Репозиторий Docker

    Репозиторием Docker (Docker Repository) называют набор образов Docker, обладающих одинаковыми именами и разными тегами. Теги — это идентификаторы образов.

    Обычно в репозиториях хранятся разные версии одних и тех же образов. Например, Python — это имя популярнейшего официального репозитория Docker на хабе Docker. А вот Python:3.7-slim — это версия образа с тегом 3.7-slim в репозитории Python. В реестр можно отправить как целый репозиторий, так и отдельный образ.

Docker CLI — консольный клиент, позволяющий управлять Docker через интерфейс командной строки.

Консольный клиент содержит команды для управления объектами Docker. Список основных команд:

    docker ps;
    docker run;
    docker image;
    docker container;
    docker volume.

### Как пользоваться

Ключи командного интерфейса Docker CLI хорошо проработаны и похожи на консольные команды в bash. Например,
дополнительный ключ prune позволяет удалять неиспользуемые объекты. Ключ rm служит для удаления, а ключ ls для просмотра
объектов. Объекты Docker в обязательном порядке имеют уникальное имя. Если вы не именуете объект специально, то имя
объекта формируется с помощью хэш-функции. Если вы попытаетесь создать объект одного и того же типа с уже использованным
именем, в этом вам будет отказано.

Мониторинг запущенных контейнеров

    docker ps — просмотр запущенных контейнеров.
    docker ps -a — ключ -a выводит и запущенные, и остановленные контейнеры.
    docker ps -s — ключ -s выводит дисковое пространство, используемое каждым запущенным контейнером.
    docker ps -f name=hello — ключ -f фильтрует список контейнеров по имени, например, hello.

### Запуск контейнеров

Для запуска контейнера, который доступен локально или на Docker Hub, выполните команду:

    docker run --name test -i -t hello 
    или
    docker exec -it тут_имя_контейнера bash

Ключ --name используется для установки имени запущенного контейнера. Ключи -i и -t указывают, что для запуска контейнера
будет использоваться стандартный поток ввода и терминал TTY соответственно. Для того чтобы при запуске контейнера
примонтировать том, который будет связан с папкой на вашем компьютере, а потом получить доступ к контейнеру через
терминал, выполните команду:

    docker run -t -i --mount type=bind,src=/data,dst=/data hello bash

### Управление образами

Вы можете получить список всех доступных локально образов с помощью команды:

    docker image ls

Ключи prune, rm действуют обычным способом, позволяя удалить неиспользуемые или конкретные образы соответственно. Для
работы с реестром необходимо использовать следующие команды:

    docker image pull hello — загрузка образа с именем hello из реестра;
    docker image push hello — отправка образа с именем hello в реестр;
    docker image inspect hello — полная информация о контейнере hello;
    docker image build — собрать контейнер из текущей папки с учётом Dockerfile.

### Периодическая чистка данных Докера

    docker container prune
    docker image prune
    docker volume prune
    docker network prune

### скачать все образы докера

    docker pull docker.ru/php/php-apache -a
    docker pull docker.ru/php/php-fpm -a

### Управление томами

    docker volume ls — вывод всех томов.
    docker volume ls -f name=hello — вывод всех томов с фильтрацией по имени, например, hello.
    docker volume create hello — создание нового тома, например, hello.
    docker volume inspect hello — исчерпывающая информация о томе.

### Образы Docker

Контейнер Docker — это образ Docker, вызванный к жизни. Это — самодостаточная операционная система, в которой имеется
только самое необходимое и код приложения.

Образы Docker являются результатом процесса их сборки, а контейнеры Docker — это выполняющиеся образы. В самом сердце
Docker находятся файлы Dockerfile. Подобные файлы сообщают Docker о том, как собирать образы, на основе которых
создаются контейнеры - инструкции, при сборке образа, обрабатываются сверху вниз.

При запуске команды docker build для создания нового образа подразумевается, что Dockerfile находится в текущей рабочей
директории.

Слои в итоговом образе создают только инструкции FROM, RUN, COPY, и ADD. Другие инструкции что-то настраивают, описывают
метаданные, или сообщают Docker о том, что во время выполнения контейнера нужно что-то сделать, например — открыть
какой-то порт или выполнить какую-то команду.

Дюжина инструкций Dockerfile

    FROM — задаёт базовый (родительский) образ.
    LABEL — описывает метаданные. Например — сведения о том, кто создал и поддерживает образ.
    ENV — устанавливает постоянные переменные среды.
    RUN — выполняет команду и создаёт слой образа. Используется для установки в контейнер пакетов.
    COPY — копирует в контейнер файлы и папки.
    ADD — копирует файлы и папки в контейнер, может распаковывать локальные .tar-файлы.
    CMD — описывает команду с аргументами, которую нужно выполнить когда контейнер будет запущен. Аргументы могут быть переопределены при запуске контейнера. В файле может присутствовать лишь одна инструкция CMD.
    WORKDIR — задаёт рабочую директорию для следующей инструкции.
    ARG — задаёт переменные для передачи Docker во время сборки образа.
    ENTRYPOINT — предоставляет команду с аргументами для вызова во время выполнения контейнера. Аргументы не переопределяются.
    EXPOSE — указывает на необходимость открыть порт.
    VOLUME — создаёт точку монтирования для работы с постоянным хранилищем.

Файл .dockerignore

    Вот что даёт тому, кто занимается созданием образов Docker, применение файлов .dockerignore:

    1) Это позволяет исключать из состава образа файлы, содержащие секретные сведения наподобие логинов и паролей.
    2) Это позволяет уменьшить размер образа. Чем меньше в образе файлов — тем меньше будет его размер и тем быстрее с ним можно будет работать.
    3) Это даёт возможность уменьшить число поводов для признания недействительным кэша при сборке похожих образов. Например, если при повторной сборке образа меняются некие служебные файлы проекта, наподобие файлов с журналами, из-за чего данные, хранящиеся в кэше, по сути, необоснованно признаются недействительными, это замедляет сборку образов.

Несколько советов, касающихся эффективного использования кэша Docker:

    1) Используйте всегда, когда это возможно, официальные образы в качестве базовых образов. Официальные образы регулярно обновляются, они безопаснее неофициальных образов.
    
    2) Для того чтобы собирать как можно более компактные образы, пользуйтесь базовыми образами, основанными на Alpine Linux.
    
    3) Если вы пользуетесь apt, комбинируйте в одной инструкции RUN команды apt-get update и apt-get install. Кроме того, объединяйте в одну инструкцию команды установки пакетов. Перечисляйте пакеты в алфавитном порядке на нескольких строках, разделяя список символами \. Например, это может выглядеть так:

    RUN apt-get update && apt-get install -y \
        package-one \
        package-two \
        package-three
    && rm -rf /var/lib/apt/lists/*


    Этот метод позволяет сократить число слоёв, которые должны быть добавлены в образ, и помогает поддерживать код файла в приличном виде.

    4) Включайте конструкцию вида && rm -rf /var/lib/apt/lists/* в конец инструкции RUN, используемой для установки пакетов. Это позволит очистить кэш apt и приведёт к тому, что он не будет сохраняться в слое, сформированном командой RUN.
    
    5) Разумно пользуйтесь возможностями кэширования, размещая в Dockerfile команды, вероятность изменения которых высока, ближе к концу файла.
    
    6) Пользуйтесь файлом .dockerignore.
    
    7) Взгляните на dive — отличный инструмент для исследования образов Docker, который помогает в деле уменьшения их размеров.

Создание образов

    Вот команда, которая позволяет собирать образы Docker:

    docker image build -t my_repo/my_image:my_tag .

    Флаг -t — это сокращение для --tag. Он указывает Docker на то, что создаваемому образу надо назначить предоставленный в команде тег. В данном случае это my_tag.

    Точка в конце команды указывает на то, что образ надо собрать с использованием файла Dockerfile, находящегося в текущей рабочей директории.

    После того, как образ собран, его можно отправить в удалённый реестр. Благодаря этому им смогут воспользоваться другие люди, его можно будет загрузить и запустить на другом компьютере. Предположим, вы хотите использовать Docker Hub. 

    После того, как вы зарегистрируетесь на Docker Hub, вам нужно войти в систему:

    docker login

    После входа в систему можно будет отправлять образы в реестр:

    docker image push my_repo/my_image:my_tag

### Kubernetes [&uarr;](#Readme)

Kubernetes — это система с открытым исходным кодом, предназначенная для оркестрации контейнеров. Она позволяет вам создавать, 
обновлять и масштабировать контейнеры, не беспокоясь о вынужденном простое.

Для запуска PHP-приложения Nginx выступает в роли прокси-сервера для PHP-FPM. Контейнеризация этой системы в одном контейнере может 
быть обременительной задачей, но Kubernetes поможет организовать управление обоими службами, расположенными в отдельных контейнерах. 
Использование Kubernetes позволяет вам организовать многократное использование ваших контейнеров и переключение между ними, и вам не 
придется каждый раз повторно собирать образ контейнера при выходе новой версии Nginx или PHP.

Проект преследует две цели. Если вы пользуетесь контейнерами Docker, возникает следующий вопрос о том, как масштабировать и запускать 
контейнеры сразу на большом количестве хостов Docker, а также как выполнять их балансировку. В проекте предлагается высокоуровневый API, 
определяющее логическое группирование контейнеров, позволяющее определять пулы контейнеров, балансировать нагрузку, а также задавать их 
размещение.

### LXC [&uarr;](#Readme)

Контейнер LXC для веб-разработки это альтернатива Docker.

#### В чем разница LXC и Docker:

- Docker - это контейнер для упаковки одного процесса или службы; на практике Docker это пачка легких контейнеров для упаковки одного веб-сервиса;
- LXC - это легкий контейнер на один веб-сервис или сайт, включающий все службы, которые нужны для его функционирования.

#### В каких случаях удобно применять LXC:

- Legacy: у вас уже есть веб-сервис/сайт размещенный на выделенном сервере и нужно упаковать его в форме контейнера, который можно отдать разработчикам, либо перенести на другой сервер (резервный или stage);
- Вам нравится работать в окружении, где все службы собраны в одном контейнере;
- Нужна изоляция на сервере чтобы каждый веб-сервис находился в своем контейнере, но при этом не терять производительность как в случае с виртуальными машинами;
- Если вы умеете настраивать основные сервисы в Linux, значит вы сможете создать LXC контейнер под ваш проект. LXC очень похож на обычную виртуалку.

#### Резюме по LXC

- Низкий порог вхождения: можно создать свой контейнер за минуты;
- хорошо подходит для упаковки существующих проектов и для legacy;
- если нужно посмотреть чей-то веб проект, установить определенные версии mysql/nginx или другие программы, при этом не затрагивая основную систему;
- он легок, экономит время при отладке и настройке;
- проверено работает при наличии sudo, хотя фича unprivileged контейнеров есть;
- классно сочетается с zfs, в этом случае получаем мгновенные снэпшоты и дополнительную надежность.

#### Когда Docker может быть лучше

- Вам нужен `IaC`. Dockerfile это отраслевой стандарт.В LXC похожее отсутствует. Концепция Infrastructiure as Code мне очень близка, я попробовал создать shell-скрипт который является аналогом Dockerfile чтобы воспроизводит LAMP окружение на LXC, но с помощью скрипта не обновить одной командой продакшен.
- Если нужен готовый публичный образ какой-то программы или опубликовать свой образ.


`Инфраструктура как код (англ. Infrastructure-as-Code; IaC)` — это подход для управления и описания инфраструктуры ЦОД через конфигурационные 
файлы, а не через ручное редактирование конфигураций на серверах или интерактивное взаимодействие.

`IaC` популярен в облачных вычислениях, который называется инфраструктура как сервис (IaaS). Основная идея IaC подхода это — описывать 
инфраструктуру кодом, переиспользуя практики из разработки ПО. Код для управления инфраструктурой может быть написан как в декларативном
стиле (встречается чаще), так и императивном. 
